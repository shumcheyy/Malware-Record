### Introduction
Researchers from Sophos detected ransomware, Epsilon Red, in an investigation on US based Hospitality sector company.Andrew Brandt wrote the report: https://news.sophos.com/en-us/2021/05/28/epsilonred/

The ransomware is named after am enemy character in X-Men, super soldier of russian origin with 4 mechanical tentacles, which seems to represent the way the ransomware is spreads in a corporate network.It is written in Golang. Deployed on the back of a set of PS scripts(12 Scripts) developed for making encryption, exploiting flaws in unpatched MS Exchange Servers

> Based on the cryptocurrency address provided by the attackers, it appears that at least one of their victims paid a ransom of 4.29BTC on May 15th (valued at roughly $210,000 on that date). 

### Working

We saw that there are 12 PowerShell scripts numbered sequentially [{1..12}.ps1], RED.exe, P.exe, C.ps1. S.ps1

![](https://news.sophos.com/wp-content/uploads/2021/05/epsilonred-files-in-folder.png)

During the attack, the threat actors launched this series of PS scripts that prepared the attacked machines for the final ransomware payload and ultimately delivered and initiated it.The PowerShell orchestration was, itself, created and triggered by a PowerShell script named **RED.ps1** that was executed on the target machines using WMI.This script retrives and unpacks into system32 folder a .7z file that contains all these abobe scripts and the executable.

Also schedule tasks that run scripts through 1 to 12 but skips 7 and 8

A typical schedule using PS looked like:
> C:\Windows\system32\schtasks.exe /create /tn Microsoft\Windows\TASK12 /tr "powershell -file c:\windows\system32\RED\12.ps1" /sc minute /mo 2 /ru SYSTEM /f 

The red.ps1 script unpacks RED.7z into the %SYSTEM%\RED directory, then creates scheduled tasks that run the unpacked scripts. But then it waits one hour, and executes commands that modify the Windows Firewall rules such that the firewall blocks inbound connections on all TCP ports except the Remote Desktop Protocol’s 3389/tcp and the communications port used by a commercial tool called ![Remote Utilities](https://www.remoteutilities.com/), 5650/tcp. 

The below image shows how the script Red.ps1 changes the firewall rules
![Shell includes commands that remove tracks](https://news.sophos.com/wp-content/uploads/2021/05/epsilonred-firewall-commands-logo.png?resize=768,260)

Oddly, it does this by first blocking inbound traffic to ports 80 and 443, then redundantly blocks entire large ranges of ports that include 80 and 443, but also exclude the RDP and Remote Utilities ports: 1-3388, 3390-5649, and 5651-65352. 
[](https://news.sophos.com/wp-content/uploads/2021/05/epsilonred-firewallrules-logo.png?resize=768,182)

After gaining initial access to victim's network, the attackers downloaded Remote Utilities and Tor Browser as an alternative way to get inital access if the inital access point gets locked down

[](https://news.sophos.com/wp-content/uploads/2021/05/epsilonred-redps1-schtasks-logo.png?resize=1024,422)

### What did the scripts do?

>
>> These strings indicate the attackers are not only trying to shut down security tools, but also database services, backup programs, office applications, email clients, QuickBooks, and even Steam, the gaming platform.  
>> The 1.ps1 file looks for processes that contain any of the following strings in their process name, and attempts to kill them:
>>'sql','Sql','SQL','BASup','Titan','SBAM','sbam','vipre','Vipre','Cylance','cylance','Senti','senti','sql','backup','veeam','outlook','word','excel','office','ocomm','dbsnmp','onenote','firefox','xfssvccon','infopath','wordpa','isqlplussvc','sql','dbeng50','mspub','mydesktopqos','ocautoupds','thunderbird','encsvc','oracle','mydesktopservice','thebat','agntsvc','steam','ocssd','tbirdconfig','synctime','visio','sqbcoreservice','winword','msaccess','powerpnt','mepocs','memtas','svc$','vss','sophos','crm','quickbooks','pos','qb','sage','SQL','prc','w3wp','java','store','ax32','dbs','wordpad','VeeamAgent','Backup','Cloud','Mbae','MB3','WRSA','rsa','wrsa'

>> **2.ps1** deletes all the Volume Shadow Copies on the system by running a single command (vssadmin.exe delete shadows /all /quiet), while 
>> **3.ps1** disables automatic repairs that Windows might try to run upon a reboot. 

>> **4.ps1** then attempts to delete the Volume Shadow Copies using a different method: 

>> wmic shadowcopy delete /nointeractive
>> Get-WmiObject Win32_ShadowCopy | % { $_.Delete() }
>> Get-WmiObject Win32_ShadowCopy | Remove-WmiObject
>> Get-WmiObject Win32_Shadowcopy | ForEach-Object { $_Delete(); }
> Get-CimInstance Win32_ShadowCopy | Remove-CimInstance 

**5.ps1** executes two commands that, between them, delete Windows Event Logs, which would hinder an investigation. 

Similarly to 1.ps1, **6.ps1** attempts to kill not processes but services, based on a list of strings that may appear in the services’ names:  

‘sql’,’Sql’,’SQL’,’BASup’,’Titan’,’Cylance’,’cylance’,’Defend’,’NisSvc’,’Veeam’,’veeam’,’backup’,’Backup’,’rsa’,’wrsa’,’WRSA’,’RSA’

It also disables Windows defender by setting the following Windows Registry key:  

reg add “HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender” /f /v DisableAntiSpyware /t REG_DWORD /d

**9.ps1**, which is executed ﬁrst, attempts to invoke the Uninstaller for security software from Sophos, Trend Micro, Cylance, MalwareBytes, Sentinel One, Vipre, Webroot, and several cloud backup agents

**10.ps1** then, redundantly, runs the dropped p.exe executable, which suspends the processes that contain the following strings, and clears their logs:




















### REFERENCES
* [Article by Andrew Brandt](https://news.sophos.com/en-us/2021/05/28/epsilonred/)
* [Youtube Video of IT AND DEVOPS MASTERCLASS](https://www.youtube.com/watch?v=pW25qpIDTIc)
